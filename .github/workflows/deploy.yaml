on:
  workflow_run:
    workflows: ["Build and Push to Docker Hub"]
    types:
      - completed

  
jobs:
  run_pull:
    name: run pull
    permissions:
      contents: write
      pages: write
      id-token: write
    runs-on: ubuntu-latest
    
    steps:
    - name: install ssh keys
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SSH_HOST }} > ~/.ssh/known_hosts
    - name: connect and pull
      run: ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd ${{ secrets.WORK_DIR }} && docker-compose stop && docker rm $(docker ps -aq) && docker rmi $(docker image ls -q) && docker-compose pull && docker-compose up -d && exit"
    - name: cleanup
      run: rm -rf ~/.ssh

